#!/bin/sh

#todo:
#add in optional auto starting/stopping of postgres
#check if Gemfile was modified before copying it EVERY time.

#normally msf makes this dir, however, this script runs first
if [ ! -d ~/.msf4 ]; then
	mkdir ~/.msf4
fi

#we cannot control if msf* exits normally so always start with cleanup
if [ -f ~/.msf4/Gemfile ]; then
	rm ~/.msf4/Gemfile
fi

#fetch the latest Gemfile from the selected version of msf
cp /usr/lib/metasploit/Gemfile ~/.msf4

#ensure Gemfile.lock is up to date
BUNDLE_GEMFILE=~/.msf4/Gemfile bundle check > /dev/null 2>&1
if [ "$?" != "0" ]; then
	if [ -f ~/.msf4/Gemfile.lock ]; then
		rm ~/.msf4/Gemfile.lock
	else
		echo "Something went wrong, please open a bug for metasploit on https://bugs.gentoo.org"
	fi
fi

#ready to go
BUNDLE_GEMFILE=~/.msf4/Gemfile exec /usr/lib/metasploit/$(basename $0) "$@"
#profit
