diff -ruN gcc-3.4.6.orig/gcc/fixinc/fixincl.x gcc-3.4.6/gcc/fixinc/fixincl.x
--- gcc-3.4.6.orig/gcc/fixinc/fixincl.x	2005-12-16 19:18:36.000000000 +0100
+++ gcc-3.4.6/gcc/fixinc/fixincl.x	2008-05-09 14:50:49.000000000 +0200
@@ -2,11 +2,11 @@
  * 
  * DO NOT EDIT THIS FILE   (fixincl.x)
  * 
- * It has been AutoGen-ed  Friday December 16, 2005 at 01:14:56 PM EST
+ * It has been AutoGen-ed  Friday May  9, 2008 at 02:47:17 PM CEST
  * From the definitions    inclhack.def
  * and the template file   fixincl
  */
-/* DO NOT CVS-MERGE THIS FILE, EITHER Fri Dec 16 13:14:56 EST 2005
+/* DO NOT CVS-MERGE THIS FILE, EITHER Fri May  9 14:47:17 CEST 2008
  *
  * You must regenerate it.  Use the ./genfixes script.
  *
@@ -15,7 +15,7 @@
  * certain ANSI-incompatible system header files which are fixed to work
  * correctly with ANSI C and placed in a directory that GNU C will search.
  *
- * This file contains 189 fixup descriptions.
+ * This file contains 190 fixup descriptions.
  *
  * See README for more information.
  *
@@ -42,6 +42,64 @@
 
 /* * * * * * * * * * * * * * * * * * * * * * * * * *
  *
+ *  Description of Aab_Aix_Stdio fix
+ */
+tSCC zAab_Aix_StdioName[] =
+     "AAB_aix_stdio";
+
+/*
+ *  File name selection pattern
+ */
+tSCC zAab_Aix_StdioList[] =
+  "|stdio.h|";
+/*
+ *  Machine/OS name selection pattern
+ */
+tSCC* apzAab_Aix_StdioMachs[] = {
+        "*-*-aix*",
+        (const char*)NULL };
+
+/*
+ *  content selection pattern - do fix if pattern found
+ */
+tSCC zAab_Aix_StdioSelect0[] =
+       "define fopen fopen64";
+
+#define    AAB_AIX_STDIO_TEST_CT  1
+static tTestDesc aAab_Aix_StdioTests[] = {
+  { TT_EGREP,    zAab_Aix_StdioSelect0, (regex_t*)NULL }, };
+
+/*
+ *  Fix Command Arguments for Aab_Aix_Stdio
+ */
+static const char* apzAab_Aix_StdioPatch[] = {
+    "wrap",
+    "",
+    "\n\
+#if defined __GNUG__ && defined _LARGE_FILES && defined __cplusplus\n\
+#define __need__aix_stdio_h_fix\n\
+#ifdef __need__aix_stdio_h_fix\n\
+#undef fseeko\n\
+#undef ftello\n\
+#undef fgetpos\n\
+#undef fsetpos\n\
+#undef fopen\n\
+#undef freopen\n\
+/* Alias the symbols using asm */\n\
+extern \"C\" {\n\
+extern int fgetpos(FILE *, fpos64_t *) __asm__(\"fgetpos64\");\n\
+extern FILE *fopen(const char *, const char *) __asm__(\"fopen64\");\n\
+extern FILE *freopen(const char *, const char *, FILE *) __asm__(\"freopen64\");\n\
+extern int fseeko(FILE *, off64_t, int) __asm__(\"fseeko64\");\n\
+extern int fsetpos(FILE *, const fpos64_t *) __asm__(\"fsetpos64\");\n\
+extern off64_t ftello(FILE *) __asm__(\"ftello64\");\n\
+}\n\
+#endif\n\
+#endif\n",
+    (char*)NULL };
+
+/* * * * * * * * * * * * * * * * * * * * * * * * * *
+ *
  *  Description of Aab_Fd_Zero_Asm_Posix_Types_H fix
  */
 tSCC zAab_Fd_Zero_Asm_Posix_Types_HName[] =
@@ -7602,14 +7660,15 @@
  *
  *  List of all fixes
  */
-#define REGEX_COUNT          225
+#define REGEX_COUNT          226
 #define MACH_LIST_SIZE_LIMIT 261
-#define FIX_COUNT            189
+#define FIX_COUNT            190
 
 /*
  *  Enumerate the fixes
  */
 typedef enum {
+    AAB_AIX_STDIO_FIXIDX,
     AAB_FD_ZERO_ASM_POSIX_TYPES_H_FIXIDX,
     AAB_FD_ZERO_GNU_TYPES_H_FIXIDX,
     AAB_FD_ZERO_SELECTBITS_H_FIXIDX,
@@ -7802,6 +7861,11 @@
 } t_fixinc_idx;
 
 tFixDesc fixDescList[ FIX_COUNT ] = {
+  {  zAab_Aix_StdioName,    zAab_Aix_StdioList,
+     apzAab_Aix_StdioMachs,
+     AAB_AIX_STDIO_TEST_CT, FD_MACH_ONLY | FD_SUBROUTINE,
+     aAab_Aix_StdioTests,   apzAab_Aix_StdioPatch, 0 },
+
   {  zAab_Fd_Zero_Asm_Posix_Types_HName,    zAab_Fd_Zero_Asm_Posix_Types_HList,
      apzAab_Fd_Zero_Asm_Posix_Types_HMachs,
      AAB_FD_ZERO_ASM_POSIX_TYPES_H_TEST_CT, FD_MACH_ONLY | FD_REPLACEMENT,
diff -ruN gcc-3.4.6.orig/gcc/fixinc/inclhack.def gcc-3.4.6/gcc/fixinc/inclhack.def
--- gcc-3.4.6.orig/gcc/fixinc/inclhack.def	2005-12-16 19:18:36.000000000 +0100
+++ gcc-3.4.6/gcc/fixinc/inclhack.def	2008-05-09 14:47:15.000000000 +0200
@@ -20,6 +20,47 @@
 FIXINC_DEBUG = yes;
 #endif
 
+/* On AIX when _LARGE_FILES is defined stdio.h defines fopen to
+ * fopen64 etc. and this causes problems when building with g++
+ * because cstdio udefs everything from stdio.h, leaving us with
+ * ::fopen has not been declared errors. This fixes stdio.h to
+ * undef those defines and use __asm__ to alias the symbols if
+ * building with g++ and -D_LARGE_FILES
+ */
+fix = {
+	hackname  = AAB_aix_stdio;
+	files     = stdio.h;
+	select    = "define fopen fopen64";
+	mach      = "*-*-aix*";
+
+	c_fix	  = wrap;
+
+	c_fix_arg = "";
+
+	c_fix_arg = "\n" 
+	"#if defined __GNUG__ && defined _LARGE_FILES && defined __cplusplus\n"
+	"#define __need__aix_stdio_h_fix\n"
+	"#ifdef __need__aix_stdio_h_fix\n"
+	"#undef fseeko\n"
+	"#undef ftello\n"
+	"#undef fgetpos\n"
+	"#undef fsetpos\n"
+	"#undef fopen\n"
+	"#undef freopen\n"
+	"/* Alias the symbols using asm */\n"
+	"extern \"C\" {\n"
+	"extern int fgetpos(FILE *, fpos64_t *) __asm__(\"fgetpos64\");\n"
+	"extern FILE *fopen(const char *, const char *) __asm__(\"fopen64\");\n"
+	"extern FILE *freopen(const char *, const char *, FILE *) __asm__(\"freopen64\");\n"
+	"extern int fseeko(FILE *, off64_t, int) __asm__(\"fseeko64\");\n"
+	"extern int fsetpos(FILE *, const fpos64_t *) __asm__(\"fsetpos64\");\n"
+	"extern off64_t ftello(FILE *) __asm__(\"ftello64\");\n"
+	"}\n"
+	"#endif\n"
+	"#endif\n";
+	test_text = "";
+};
+
 /*
  *  This fixes __FD_ZERO bug for linux 2.x.y (x <= 2 && y <= some n)
  */
diff -ruN gcc-3.4.6.orig/gcc/fixinc/tests/base/stdio.h gcc-3.4.6/gcc/fixinc/tests/base/stdio.h
--- gcc-3.4.6.orig/gcc/fixinc/tests/base/stdio.h	2004-01-21 20:50:12.000000000 +0100
+++ gcc-3.4.6/gcc/fixinc/tests/base/stdio.h	2008-05-09 14:46:26.000000000 +0200
@@ -14,6 +14,11 @@
 #include <stdarg.h>
 
 
+#if defined( AAB_AIX_STDIO_CHECK )
+
+#endif  /* AAB_AIX_STDIO_CHECK */
+
+
 #if defined( ALPHA_GETOPT_CHECK )
 extern int getopt(int, char *const[], const char *);
 #endif  /* ALPHA_GETOPT_CHECK */
diff -ruN gcc-3.4.6.orig/gcc/testsuite/g++.dg/other/pr20366.C gcc-3.4.6/gcc/testsuite/g++.dg/other/pr20366.C
--- gcc-3.4.6.orig/gcc/testsuite/g++.dg/other/pr20366.C	1970-01-01 01:00:00.000000000 +0100
+++ gcc-3.4.6/gcc/testsuite/g++.dg/other/pr20366.C	2008-05-09 14:46:26.000000000 +0200
@@ -0,0 +1,80 @@
+// Test fix for PR20366
+// 
+// { dg-do compile  { target *-*-aix* } }
+// { dg-options "-D_LARGE_FILES" }
+//
+// cstdio includes stdio.h and undefs most of the functions declared
+// therein, unfortunately this means that #define fopen fopen64 goes
+// away. This tests the fix, and ensures that with -D_LARGE_FILES
+// fopen et. al. are indeed aliased to the large file equivalents.
+//
+// There are many other #define foo foo64 in the AIX headers, but
+// these all work out fine as they are not undefined in libstdc++.
+// This list is probably incomplete:
+//
+// Symbol          Return type     Large file declaration.
+// 
+// aio.h                      (different for different AIX versions)
+// =====
+// aio_read        int        aio_read64(int, struct aiocb64 *);
+// aio_write       int        aio_write64(int, struct aiocb64 *);
+// lio_listio      int        lio_listio64(int, struct liocb64 *[], int, void *);
+// aio_cancel      int        aio_cancel64(int, struct aiocb64 *);
+// aio_suspend     int        aio_suspend64(int, struct aiocb64 *[]);
+// 
+// stdio.h
+// =======
+// fgetpos         int        fgetpos64(FILE *, fpos64_t *);
+// fopen           FILE      *fopen64(const char *, const char *);
+// freopen         FILE      *freopen64(const char *, const char *, FILE *);
+// fseeko          int        fseeko64(FILE *, off64_t, int);
+// fsetpos         int        fsetpos64(FILE *, const fpos64_t *);
+// ftello          off64_t    ftello64(FILE *);
+// 
+// unistd.h
+// ========
+// fclear          off64_t    fclear64(int, off64_t);
+// fsync_range     int        fsync_range64(int, int, off64_t, off64_t);
+// ftruncate       int        ftruncate64(int, off64_t);
+// truncate        int        truncate64(const char *, off64_t);
+// lseek           off64_t    lseek64(int, off64_t, int);
+// pread           ssize_t    pread64(int, void *, size_t, off64_t);
+// pwrite          ssize_t    pwrite64(int, const void *, size_t, off64_t);
+// 
+// fcntl.h
+// =======
+// open            int        open64(const char *, int, ...);
+// creat           int        creat64(const char *, mode_t);
+// 
+// sys/stat.h
+// ==========
+// stat            int        stat64(const char *, struct stat64 *);
+// fstat           int        fstat64(int, struct stat64 *);
+// lstat           int        lstat64(const char *, struct stat64 *);
+// 
+// stdlib.h
+// ========
+// mkstemp         int        mkstemp64(char *);
+// 
+// ftw.h
+// =====
+// ftw             int        ftw64(const char *, int (*)(const char *,const struct stat64 *, int), int);
+// nftw            int        nftw64(const char *, int (*)(const char *, const struct stat64 *, int, struct FTW*), int, int);
+//
+// It seems unlikely that any of these will be used (and #undef'ed) by
+// libstdc++ in the future, if they are then this test and its
+// associated patch to fixincludes will have to be revisited.
+
+#include <cstdio>
+
+extern "C" {
+int        fgetpos(FILE *, fpos64_t *);
+FILE      *fopen(const char *, const char *);
+FILE      *freopen(const char *, const char *, FILE *);
+int        fseeko(FILE *, off64_t, int);
+int        fsetpos(FILE *, const fpos64_t *);
+off64_t    ftello(FILE *);
+}
+int main() { 
+  return 0;
+}
